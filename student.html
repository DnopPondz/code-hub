<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อนักเรียน (Integrated Data)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; }
        
        /* UI Components */
        .nav-item.active { background-color: #e0e7ff; color: #4338ca; border-right: 4px solid #4338ca; font-weight: bold; }
        .excel-sheet { background: white; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-radius: 8px; }
        .excel-header th { background-color: #f8fafc; color: #475569; font-weight: 600; border-bottom: 2px solid #e2e8f0; padding: 12px; text-transform: uppercase; font-size: 0.8rem; }
        .excel-row { border-bottom: 1px solid #f1f5f9; transition: background 0.15s; }
        .excel-row:hover { background-color: #f8fafc; }
        .excel-cell { padding: 12px 16px; border-right: 1px solid #f1f5f9; vertical-align: middle; }
        
        /* Input & Forms */
        input[type="number"] { transition: all 0.2s; }
        input[type="number"]:focus { transform: scale(1.02); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Detail Box Animation */
        .detail-box { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s ease; background: #f8fafc; border-radius: 6px; }
        .detail-box.open { max-height: 200px; opacity: 1; margin-top: 8px; padding: 10px; border: 1px dashed #94a3b8; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-md">
                <i class="fas fa-university"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-lg">School Admin</h1>
                <div class="text-[10px] text-gray-400">ระบบจัดการและประเมินผล</div>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-1">
            <button onclick="App.switchView('dashboard')" id="nav-dashboard" class="nav-item active w-full text-left px-6 py-3 text-sm hover:bg-gray-50 flex items-center transition-colors">
                <i class="fas fa-chart-pie w-5 text-center mr-3"></i> ภาพรวม (Dashboard)
            </button>
            <button onclick="App.switchView('entry')" id="nav-entry" class="nav-item w-full text-left px-6 py-3 text-sm hover:bg-gray-50 flex items-center transition-colors">
                <i class="fas fa-clipboard-check w-5 text-center mr-3"></i> เช็คชื่อ (Check-in)
            </button>
            <button onclick="App.switchView('analysis')" id="nav-analysis" class="nav-item w-full text-left px-6 py-3 text-sm hover:bg-gray-50 flex items-center transition-colors">
                <i class="fas fa-table w-5 text-center mr-3"></i> รายงานคะแนน (Report)
            </button>
            <div class="pt-4 mt-4 border-t border-gray-100 px-6">
                <button onclick="App.switchView('settings')" id="nav-settings" class="w-full text-left text-xs text-gray-500 hover:text-indigo-600 flex items-center transition-colors">
                    <i class="fas fa-sliders-h w-5 text-center mr-3"></i> ตั้งค่าเกณฑ์คะแนน
                </button>
            </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-slate-50">
        
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">ภาพรวม</h2>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-1.5">
                    <i class="fas fa-door-open text-indigo-500 mr-2"></i>
                    <select id="room-select" onchange="App.changeRoom()" class="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer min-w-[150px]"></select>
                </div>
                <div class="h-8 w-px bg-gray-200"></div>
                <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full flex items-center">
                    <i class="far fa-calendar-alt mr-2"></i> <span id="header-date">...</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            
            <div id="view-dashboard" class="absolute inset-0 overflow-auto p-6 space-y-6 custom-scroll">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs font-bold text-gray-400">มาเรียนวันนี้</div>
                        <div class="text-4xl font-bold text-slate-800 mt-2" id="dash-pres">0</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs font-bold text-gray-400">ลาป่วย / ลากิจ</div>
                        <div class="flex items-end gap-2 mt-2">
                            <div class="text-4xl font-bold text-purple-600" id="dash-leaves">0</div>
                            <div class="text-xs text-gray-400 mb-1">คน</div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs font-bold text-gray-400">คะแนนเฉลี่ยห้อง (จิตพิสัย)</div>
                        <div class="flex items-end gap-2 mt-2">
                            <div class="text-4xl font-bold text-indigo-600" id="dash-score">100</div>
                            <div class="text-xs text-gray-400 mb-1">คะแนน</div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs font-bold text-gray-400">สถานะห้องเรียน</div>
                        <div class="mt-3" id="dash-status-badge">
                            <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold">กำลังโหลด...</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pb-10">
                    <div class="lg:col-span-2 bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-6"><i class="fas fa-chart-area mr-2"></i>แนวโน้มคะแนนจิตพิสัย (5 วันล่าสุด)</h3>
                        <div id="chart-container" class="h-48 flex items-end justify-around px-4 space-x-6"></div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col h-[300px]">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-sm text-gray-600 flex justify-between">
                            <span><i class="fas fa-user-injured mr-2"></i>รายการลาวันนี้</span>
                            <span class="text-xs bg-white border px-2 py-0.5 rounded" id="dash-date-tag">...</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-0">
                            <table class="w-full text-left text-sm"><tbody id="dash-leave-list"></tbody></table>
                            <div id="dash-no-leaves" class="p-8 text-center text-gray-400 text-xs">ไม่มีข้อมูลการลา</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-entry" class="hidden absolute inset-0 flex flex-col bg-slate-50">
                <div class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-10">
                    <div class="flex items-center gap-4">
                        <input type="date" id="entry-date" class="bg-gray-50 border border-gray-300 rounded px-3 py-1.5 text-sm font-bold outline-none focus:border-indigo-500 text-slate-700">
                        <div class="h-8 w-px bg-gray-200"></div>
                        <div class="flex gap-4 text-xs font-bold">
                            <span class="text-green-600 bg-green-50 px-2 py-1 rounded">มา: <span id="live-pres">0</span></span>
                            <span class="text-purple-600 bg-purple-50 px-2 py-1 rounded">ลา: <span id="live-leaves">0</span></span>
                            <span class="text-red-600 bg-red-50 px-2 py-1 rounded">ขาด: <span id="live-abs">0</span></span>
                        </div>
                    </div>
                    <button onclick="App.saveAttendance()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-md transition-transform active:scale-95 flex items-center">
                        <i class="fas fa-save mr-2"></i> บันทึกผล
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                    <div class="max-w-5xl mx-auto excel-sheet">
                        <table class="w-full text-left border-collapse">
                            <thead class="excel-header">
                                <tr>
                                    <th class="w-16 text-center">เลขที่</th>
                                    <th>ชื่อ - นามสกุล</th>
                                    <th class="w-[60%] text-center">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="entry-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-analysis" class="hidden absolute inset-0 flex flex-col bg-slate-50">
                <div class="px-6 py-3 bg-white border-b border-gray-200 flex justify-between items-center">
                    <div class="space-x-1">
                        <button onclick="App.renderAnalysis('7')" class="an-btn px-3 py-1 text-xs border rounded bg-white hover:bg-gray-50">7 วัน</button>
                        <button onclick="App.renderAnalysis('30')" class="an-btn px-3 py-1 text-xs border rounded bg-white hover:bg-gray-50">1 เดือน</button>
                        <button onclick="App.renderAnalysis('year')" class="an-btn px-3 py-1 text-xs border rounded bg-indigo-50 text-indigo-600 border-indigo-200 font-bold">ทั้งปี</button>
                    </div>
                    <div class="text-xs text-gray-500"><i class="fas fa-info-circle"></i> คะแนนอิงตามค่าที่ตั้งไว้ (Real-time)</div>
                </div>
                <div class="flex-1 overflow-auto p-6 custom-scroll">
                    <div class="excel-sheet">
                        <table class="w-full text-left border-collapse">
                            <thead class="excel-header">
                                <tr>
                                    <th class="text-center w-12">เลขที่</th>
                                    <th>ชื่อ - นามสกุล</th>
                                    <th class="text-center text-red-600 w-16">ขาด</th>
                                    <th class="text-center text-yellow-600 w-16">สาย</th>
                                    <th class="text-center text-purple-600 w-16">ลา</th>
                                    <th class="text-center bg-slate-50 w-32 border-l">หักคะแนน</th>
                                    <th class="text-center bg-indigo-50 text-indigo-700 font-bold w-24 text-lg">จิตพิสัย</th>
                                    <th class="text-center w-24">ประเมิน</th>
                                </tr>
                            </thead>
                            <tbody id="analysis-table" class="text-sm bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden absolute inset-0 flex flex-col bg-slate-50 p-8 overflow-auto">
                <div class="max-w-3xl mx-auto bg-white border border-slate-200 rounded-xl shadow-sm p-8">
                    <div class="border-b pb-4 mb-6 flex justify-between items-center">
                        <h3 class="font-bold text-xl text-slate-800"><i class="fas fa-sliders-h mr-2"></i>ตั้งค่าเกณฑ์การตัดคะแนน</h3>
                        <div class="text-xs bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-200">
                            <i class="fas fa-exclamation-triangle"></i> การแก้ไขมีผลทันทีกับคะแนนทั้งระบบ
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-red-50 rounded-lg border border-red-100">
                            <div class="font-bold text-red-700 mb-3"><i class="fas fa-times-circle"></i> ขาดเรียน (Absent)</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">เริ่มหักเมื่อเกิน (ครั้ง)</label>
                                    <input type="number" id="lim-abs" class="w-full mt-1 border-red-200 rounded p-2 text-center font-bold focus:border-red-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">หักคะแนน (ต่อครั้ง)</label>
                                    <input type="number" id="cut-abs" class="w-full mt-1 border-red-200 rounded p-2 text-center font-bold text-red-600 focus:border-red-500 outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                            <div class="font-bold text-yellow-700 mb-3"><i class="fas fa-clock"></i> มาสาย (Late)</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">เริ่มหักเมื่อเกิน (ครั้ง)</label>
                                    <input type="number" id="lim-late" class="w-full mt-1 border-yellow-200 rounded p-2 text-center font-bold focus:border-yellow-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">หักคะแนน (ต่อครั้ง)</label>
                                    <input type="number" id="cut-late" class="w-full mt-1 border-yellow-200 rounded p-2 text-center font-bold text-red-600 focus:border-yellow-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-purple-50 rounded-lg border border-purple-100">
                            <div class="font-bold text-purple-700 mb-3"><i class="fas fa-procedures"></i> ลาป่วย (Sick)</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">เริ่มหักเมื่อเกิน (ครั้ง)</label>
                                    <input type="number" id="lim-sick" class="w-full mt-1 border-purple-200 rounded p-2 text-center font-bold focus:border-purple-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">หักคะแนน (ต่อครั้ง)</label>
                                    <input type="number" id="cut-sick" class="w-full mt-1 border-purple-200 rounded p-2 text-center font-bold text-red-600 focus:border-purple-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-orange-50 rounded-lg border border-orange-100">
                            <div class="font-bold text-orange-700 mb-3"><i class="fas fa-user-clock"></i> ลากิจ (Personal)</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">เริ่มหักเมื่อเกิน (ครั้ง)</label>
                                    <input type="number" id="lim-pers" class="w-full mt-1 border-orange-200 rounded p-2 text-center font-bold focus:border-orange-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">หักคะแนน (ต่อครั้ง)</label>
                                    <input type="number" id="cut-pers" class="w-full mt-1 border-orange-200 rounded p-2 text-center font-bold text-red-600 focus:border-orange-500 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-4 border-t flex justify-end">
                        <button onclick="App.saveSettings()" class="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95">
                            <i class="fas fa-save mr-2"></i> บันทึกการตั้งค่า
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const App = (function() {
            // --- 1. CENTRALIZED DATA CONFIG ---
            const CLASS_DATA = {
                "room_1": { name: "ม.1/1 (ห้องคิง)", students: [ {id:1, name:"ด.ช. สมชาย ใจดี"}, {id:2, name:"ด.ญ. สมหญิง รักเรียน"}, {id:3, name:"ด.ช. กล้าหาญ"}, {id:4, name:"ด.ญ. มานี"} ] },
                "room_2": { name: "ม.1/2 (วิทย์)", students: [ {id:1, name:"ด.ช. มานะ"}, {id:2, name:"ด.ญ. ชูใจ"}, {id:3, name:"ด.ช. ปิติ"}, {id:4, name:"ด.ญ. แก้ว"} ] },
                "room_3": { name: "ม.1/3 (ศิลป์)", students: [ {id:1, name:"ด.ช. เอ"}, {id:2, name:"ด.ญ. ไก่"} ] }
            };

            let currentRoomId = Object.keys(CLASS_DATA)[0];
            
            // --- 2. STATE MANAGEMENT (Single Source of Truth) ---
            const Store = {
                data: JSON.parse(localStorage.getItem('app_data')) || {},
                details: JSON.parse(localStorage.getItem('app_details')) || {},
                settings: JSON.parse(localStorage.getItem('app_settings')) || {
                    abs: { lim: 3, cut: 5 },
                    late: { lim: 5, cut: 1 },
                    sick: { lim: 5, cut: 0 },
                    pers: { lim: 3, cut: 2 }
                },
                save() {
                    localStorage.setItem('app_data', JSON.stringify(this.data));
                    localStorage.setItem('app_details', JSON.stringify(this.details));
                    localStorage.setItem('app_settings', JSON.stringify(this.settings));
                },
                getKey(date) { return `${date}_${currentRoomId}`; }
            };

            // --- 3. LOGIC & CALCULATIONS ---
            function calculateStudentScore(studentId, dateRange = 'year') {
                // Get dates
                const dates = [];
                const today = new Date();
                const days = dateRange === '7' ? 7 : (dateRange === 'year' ? 365 : 30);
                for(let i=0; i<days; i++) {
                    const d = new Date(); d.setDate(today.getDate() - i);
                    dates.push(Store.getKey(d.toISOString().split('T')[0]));
                }

                // Count Stats
                let stats = { abs:0, late:0, sick:0, pers:0 };
                dates.forEach(key => {
                    const status = Store.data[key]?.[studentId];
                    if(status === 'absent') stats.abs++;
                    if(status === 'late') stats.late++;
                    if(status === 'sick') stats.sick++;
                    if(status === 'personal') stats.pers++;
                });

                // Calculate Deduction based on Settings
                let deduction = 0;
                const s = Store.settings;
                
                if(stats.abs > s.abs.lim) deduction += (stats.abs - s.abs.lim) * s.abs.cut;
                if(stats.late > s.late.lim) deduction += (stats.late - s.late.lim) * s.late.cut;
                if(stats.sick > s.sick.lim) deduction += (stats.sick - s.sick.lim) * s.sick.cut;
                if(stats.pers > s.pers.lim) deduction += (stats.pers - s.pers.lim) * s.pers.cut;

                let finalScore = 100 - deduction;
                return { stats, deduction, score: Math.max(0, finalScore) };
            }

            // --- 4. UI RENDERING ---
            
            function init() {
                // Setup Room Select
                const sel = document.getElementById('room-select');
                Object.keys(CLASS_DATA).forEach(k => {
                    const opt = document.createElement('option'); opt.value = k; opt.innerText = CLASS_DATA[k].name;
                    sel.appendChild(opt);
                });
                
                // Setup Date
                const today = new Date();
                document.getElementById('header-date').innerText = today.toLocaleDateString('th-TH', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
                document.getElementById('entry-date').value = today.toISOString().split('T')[0];
                document.getElementById('dash-date-tag').innerText = today.toISOString().split('T')[0];

                // Load Settings UI
                document.getElementById('lim-abs').value = Store.settings.abs.lim; document.getElementById('cut-abs').value = Store.settings.abs.cut;
                document.getElementById('lim-late').value = Store.settings.late.lim; document.getElementById('cut-late').value = Store.settings.late.cut;
                document.getElementById('lim-sick').value = Store.settings.sick.lim; document.getElementById('cut-sick').value = Store.settings.sick.cut;
                document.getElementById('lim-pers').value = Store.settings.pers.lim; document.getElementById('cut-pers').value = Store.settings.pers.cut;

                // Events
                document.getElementById('entry-date').addEventListener('change', renderEntry);

                switchView('dashboard');
            }

            function switchView(viewName) {
                ['dashboard', 'entry', 'analysis', 'settings'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                document.getElementById('view-'+viewName).classList.remove('hidden');
                document.getElementById('nav-'+viewName).classList.add('active');
                
                const title = viewName === 'settings' ? 'ตั้งค่าระบบ' : CLASS_DATA[currentRoomId].name;
                document.getElementById('page-title').innerText = title;

                if(viewName === 'dashboard') renderDashboard();
                if(viewName === 'entry') renderEntry();
                if(viewName === 'analysis') renderAnalysis('year');
            }

            function changeRoom() {
                currentRoomId = document.getElementById('room-select').value;
                const activeView = document.querySelector('.nav-item.active').id.replace('nav-', '');
                switchView(activeView);
            }

            // --- PAGE: ENTRY ---
            function renderEntry() {
                const date = document.getElementById('entry-date').value;
                const key = Store.getKey(date);
                const tbody = document.getElementById('entry-table');
                tbody.innerHTML = '';

                CLASS_DATA[currentRoomId].students.forEach(std => {
                    const status = Store.data[key]?.[std.id] || 'present';
                    const detail = Store.details[key]?.[std.id] || {note:'', file:''};
                    const showDet = status === 'sick' || status === 'personal';

                    const makeRadio = (val, col, icon, txt) => `
                        <label class="cursor-pointer active:scale-95 transition">
                            <input type="radio" name="st_${std.id}" value="${val}" ${status===val?'checked':''} class="peer sr-only" onchange="App.updateLiveStats(); App.toggleDetail(${std.id}, '${val}')">
                            <div class="w-14 py-2 flex flex-col items-center rounded border border-slate-200 text-gray-400 hover:bg-${col}-50 peer-checked:bg-${col}-100 peer-checked:text-${col}-700 peer-checked:border-${col}-400 shadow-sm">
                                <i class="fas fa-${icon} text-xs mb-1"></i><span class="text-[10px] font-bold">${txt}</span>
                            </div>
                        </label>`;

                    tbody.innerHTML += `
                        <tr class="excel-row">
                            <td class="excel-cell text-center text-gray-400 text-xs align-top pt-6">${std.id}</td>
                            <td class="excel-cell font-bold text-slate-700 align-top pt-6">${std.name}</td>
                            <td class="excel-cell">
                                <div class="flex justify-center gap-2 mb-2">
                                    ${makeRadio('present','green','check','มา')}
                                    ${makeRadio('late','yellow','clock','สาย')}
                                    ${makeRadio('sick','purple','procedures','ป่วย')}
                                    ${makeRadio('personal','orange','user-clock','กิจ')}
                                    ${makeRadio('absent','red','times','ขาด')}
                                </div>
                                <div id="det-${std.id}" class="detail-box ${showDet?'open':''}">
                                    <input type="text" id="note-${std.id}" value="${detail.note}" placeholder="ระบุสาเหตุ..." class="w-full text-xs border rounded p-1.5 mb-2 outline-none focus:border-indigo-500">
                                    <div class="relative"><input type="file" id="file-${std.id}" class="text-[10px] w-full text-gray-400"></div>
                                </div>
                            </td>
                        </tr>`;
                });
                updateLiveStats();
            }

            function toggleDetail(id, val) {
                const el = document.getElementById(`det-${id}`);
                if(val === 'sick' || val === 'personal') el.classList.add('open'); else el.classList.remove('open');
            }

            function updateLiveStats() {
                const checked = document.querySelectorAll('#entry-table input[type="radio"]:checked');
                let p=0, l=0, a=0;
                checked.forEach(r => {
                    if(r.value==='present' || r.value==='late') p++;
                    if(r.value==='sick' || r.value==='personal') l++;
                    if(r.value==='absent') a++;
                });
                document.getElementById('live-pres').innerText = p;
                document.getElementById('live-leaves').innerText = l;
                document.getElementById('live-abs').innerText = a;
            }

            function saveAttendance() {
                const date = document.getElementById('entry-date').value;
                const key = Store.getKey(date);
                if(!Store.data[key]) Store.data[key] = {};
                if(!Store.details[key]) Store.details[key] = {};

                CLASS_DATA[currentRoomId].students.forEach(std => {
                    const radios = document.getElementsByName(`st_${std.id}`);
                    let val = 'present';
                    for(let r of radios) if(r.checked) val = r.value;
                    
                    Store.data[key][std.id] = val;

                    if(val === 'sick' || val === 'personal') {
                        const n = document.getElementById(`note-${std.id}`).value;
                        const fInp = document.getElementById(`file-${std.id}`);
                        const f = fInp.files[0] ? fInp.files[0].name : (Store.details[key][std.id]?.file || '');
                        Store.details[key][std.id] = { note: n, file: f };
                    } else {
                        delete Store.details[key][std.id];
                    }
                });
                Store.save();
                alert('บันทึกข้อมูลเรียบร้อย');
                if(date === new Date().toISOString().split('T')[0]) renderDashboard();
            }

            // --- PAGE: DASHBOARD ---
            function renderDashboard() {
                const todayStr = new Date().toISOString().split('T')[0];
                const key = Store.getKey(todayStr);
                const students = CLASS_DATA[currentRoomId].students;
                
                let presCount = 0;
                let leaveCount = 0;
                let totalScore = 0;

                // Leave List
                const list = document.getElementById('dash-leave-list');
                list.innerHTML = '';
                let hasLeaves = false;

                students.forEach(std => {
                    // Daily Stats
                    const status = Store.data[key]?.[std.id];
                    if(status === 'present' || status === 'late') presCount++;
                    if(status === 'sick' || status === 'personal') leaveCount++;

                    // Calculate Score (Shared Logic)
                    const result = calculateStudentScore(std.id, 'year');
                    totalScore += result.score;

                    // Render Leaves
                    if(status === 'sick' || status === 'personal') {
                        hasLeaves = true;
                        const det = Store.details[key]?.[std.id] || {note:'-'};
                        const conf = status==='sick' ? {c:'purple', t:'ลาป่วย', i:'procedures'} : {c:'orange', t:'ลากิจ', i:'user-clock'};
                        list.innerHTML += `
                            <tr class="border-b border-slate-100 last:border-0">
                                <td class="p-3">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-${conf.c}-100 text-${conf.c}-600 flex items-center justify-center mr-3"><i class="fas fa-${conf.i} text-xs"></i></div>
                                        <div>
                                            <div class="font-bold text-slate-700 text-sm">${std.name}</div>
                                            <span class="text-[10px] bg-${conf.c}-50 text-${conf.c}-600 px-1 rounded border border-${conf.c}-100 mr-1">${conf.t}</span>
                                            <span class="text-xs text-gray-500 italic">"${det.note}"</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                    }
                });

                document.getElementById('dash-pres').innerText = presCount;
                document.getElementById('dash-leaves').innerText = leaveCount;
                document.getElementById('dash-no-leaves').style.display = hasLeaves ? 'none' : 'block';
                
                // Average Score
                const avgScore = students.length ? Math.round(totalScore / students.length) : 100;
                document.getElementById('dash-score').innerText = avgScore;
                
                // Status Badge
                const badge = document.getElementById('dash-status-badge');
                if(avgScore >= 80) badge.innerHTML = '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold"><i class="fas fa-check-circle mr-1"></i> ยอดเยี่ยม</span>';
                else if(avgScore >= 60) badge.innerHTML = '<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold"><i class="fas fa-exclamation-circle mr-1"></i> ปานกลาง</span>';
                else badge.innerHTML = '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold"><i class="fas fa-times-circle mr-1"></i> ต้องปรับปรุง</span>';

                // Simple Chart
                const chart = document.getElementById('chart-container'); chart.innerHTML = '';
                for(let i=4; i>=0; i--) {
                    const d = new Date(); d.setDate(new Date().getDate()-i);
                    // Mock daily score for chart (simplified)
                    const h = avgScore > 0 ? avgScore * (0.8 + Math.random()*0.4) : 50; 
                    const finalH = Math.min(100, Math.max(10, h));
                    chart.innerHTML += `
                        <div class="flex-1 flex flex-col justify-end h-full group">
                            <div class="text-xs text-center mb-1 text-slate-400 group-hover:text-indigo-600 transition">${Math.round(finalH)}</div>
                            <div class="w-full bg-indigo-500 rounded-t-md opacity-80 group-hover:opacity-100 transition-all" style="height: ${finalH}%"></div>
                            <div class="text-[10px] text-gray-400 text-center mt-2">${d.getDate()}</div>
                        </div>`;
                }
            }

            // --- PAGE: ANALYSIS ---
            function renderAnalysis(range) {
                // Button Styles
                document.querySelectorAll('.an-btn').forEach(b => b.className = "an-btn px-3 py-1 text-xs border rounded bg-white hover:bg-gray-50 text-gray-600");
                event.target.className = "an-btn px-3 py-1 text-xs border rounded bg-indigo-50 text-indigo-600 border-indigo-200 font-bold";

                const tbody = document.getElementById('analysis-table'); tbody.innerHTML = '';
                
                CLASS_DATA[currentRoomId].students.forEach(std => {
                    const result = calculateStudentScore(std.id, range);
                    const st = result.stats;
                    const score = result.score;
                    const deduct = result.deduction;

                    // Badge
                    let badge = '';
                    if(score >= 80) badge = '<span class="text-green-600 bg-green-50 px-2 py-0.5 rounded font-bold text-xs">ดีเยี่ยม</span>';
                    else if(score >= 50) badge = '<span class="text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded font-bold text-xs">พอใช้</span>';
                    else badge = '<span class="text-red-600 bg-red-50 px-2 py-0.5 rounded font-bold text-xs">เสี่ยง</span>';

                    tbody.innerHTML += `
                        <tr class="excel-row">
                            <td class="excel-cell text-center text-gray-400 text-xs">${std.id}</td>
                            <td class="excel-cell font-bold text-slate-700">${std.name}</td>
                            <td class="excel-cell text-center text-red-600 ${st.abs > Store.settings.abs.lim ? 'bg-red-50 font-bold' : ''}">${st.abs}</td>
                            <td class="excel-cell text-center text-yellow-600 ${st.late > Store.settings.late.lim ? 'bg-yellow-50 font-bold' : ''}">${st.late}</td>
                            <td class="excel-cell text-center text-purple-600 ${st.sick > Store.settings.sick.lim ? 'bg-purple-50 font-bold' : ''}">${st.sick + st.pers}</td>
                            <td class="excel-cell text-center text-red-500 font-bold bg-slate-50 border-l">${deduct > 0 ? '-'+deduct : '-'}</td>
                            <td class="excel-cell text-center text-indigo-700 font-bold bg-indigo-50 text-lg">${score}</td>
                            <td class="excel-cell text-center">${badge}</td>
                        </tr>`;
                });
            }

            // --- PAGE: SETTINGS ---
            function saveSettings() {
                Store.settings = {
                    abs: { lim: parseInt(document.getElementById('lim-abs').value)||0, cut: parseInt(document.getElementById('cut-abs').value)||0 },
                    late: { lim: parseInt(document.getElementById('lim-late').value)||0, cut: parseInt(document.getElementById('cut-late').value)||0 },
                    sick: { lim: parseInt(document.getElementById('lim-sick').value)||0, cut: parseInt(document.getElementById('cut-sick').value)||0 },
                    pers: { lim: parseInt(document.getElementById('lim-pers').value)||0, cut: parseInt(document.getElementById('cut-pers').value)||0 }
                };
                Store.save();
                alert('บันทึกการตั้งค่าเรียบร้อย! คะแนนทั้งหมดถูกคำนวณใหม่แล้ว');
            }

            // Expose public methods
            return {
                init, switchView, changeRoom, renderEntry, saveAttendance, 
                renderDashboard, renderAnalysis, saveSettings, updateLiveStats, toggleDetail
            };
        })();

        // Start App
        App.init();
    </script>
</body>
</html>